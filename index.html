<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Humanitarian Response & Coordination Platform | Afghanistan Earthquake</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-main: #f4f7fa;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #5a6a85;
            --brand-primary: #0052cc;
            --brand-secondary: #e0f3ff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --radius-md: 8px;
            --radius-lg: 16px;
            --gap-color: #d73027;
            --success-color: #1a9850;
            --male-color: #0077b6;
            --female-color: #d00000;
            --displaced-color: #0077b6;
            --pin-color: #ff6200;
            --disability-opacity: 0.6;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1920px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 2.5rem;
            margin: 0;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 img {
            height: 40px;
        }
        header p {
            margin: 4px 0 0 0;
            font-size: 1rem;
            max-width: 600px;
            text-align: center;
        }
        
        .filter-container {
            display: flex;
            gap: 16px;
            padding: 16px;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .filter-group select {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-main);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .filter-group select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        
        .grid-span-7 { grid-column: span 7; }
        .grid-span-5 { grid-column: span 5; }
        .grid-span-12 { grid-column: span 12; }

        .module-card {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 24px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .module-card h2 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .module-card h2 i {
            color: var(--brand-primary);
            font-size: 1.1em;
        }
        
        /* Map Module */
        .map-module { position: relative; padding: 0; overflow: hidden; }
        #map { height: 600px; width: 100%; }
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            font-size: 0.85rem;
        }
        .map-legend h4 { margin: 0 0 10px 0; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .legend-circle { width: 15px; height: 15px; border-radius: 50%; border: 1px solid #ccc; }

        /* Key Metrics Module */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        .metric-card {
            padding: 16px;
            text-align: center;
            border-radius: var(--radius-md);
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
        }
        .metric-card h3 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .metric-card p {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        /* Population Pyramid Styles */
        .pyramid-container { display: flex; width: 100%; height: 350px; font-size: 0.8rem; }
        .pyramid-side { flex: 1; display: flex; flex-direction: column-reverse; justify-content: space-around; }
        .pyramid-side.male { align-items: flex-end; }
        .pyramid-side.female { align-items: flex-start; }
        .age-labels { width: 60px; display: flex; flex-direction: column-reverse; justify-content: space-around; text-align: center; font-weight: 600; color: var(--text-primary); }
        .bar-wrapper { width: 100%; position: relative; height: 18px; display: flex; }
        .pyramid-side.male .bar-wrapper { flex-direction: row-reverse; }
        .bar-main, .bar-disability { height: 100%; transition: width 0.5s ease-in-out; border-radius: 3px; }
        .pyramid-side.male .bar-main { background-color: var(--male-color); }
        .pyramid-side.male .bar-disability { background: repeating-linear-gradient(45deg, var(--male-color), var(--male-color) 4px, #a8d5e9 4px, #a8d5e9 8px); }
        .pyramid-side.female .bar-main { background-color: var(--female-color); }
        .pyramid-side.female .bar-disability { background: repeating-linear-gradient(45deg, var(--female-color), var(--female-color) 4px, #f2a2a2 4px, #f2a2a2 8px); }
        .bar-label { position: absolute; top: 50%; transform: translateY(-50%); color: var(--text-primary); font-weight: 600; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); padding: 0 5px; font-size: 0.9em; }
        .pyramid-side.male .bar-label { right: 5px; }
        .pyramid-side.female .bar-label { left: 5px; }
        .pyramid-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.9rem; }
        .legend-swatch { width: 30px; height: 15px; border-radius: 3px; }

        /* Sectoral Analysis Chart Styles */
        .chart-container { width: 100%; font-size: 0.9rem; }
        .chart-row { display: flex; align-items: center; margin-bottom: 10px; }
        .chart-label { width: 130px; font-weight: 500; white-space: nowrap; color: var(--text-primary); }
        .chart-bar-bg { flex: 1; background-color: var(--bg-main); border-radius: 4px; height: 24px; }
        .chart-bar-fg { height: 100%; background-image: linear-gradient(45deg, var(--brand-primary), #4c87df); border-radius: 4px; transition: width 0.5s ease-in-out; text-align: right; color: white; padding-right: 8px; font-weight: 700; line-height: 24px; white-space: nowrap; }

        /* Response Tracking Table */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 14px 16px; border-bottom: 1px solid var(--border-color); }
        thead th { background-color: var(--bg-main); font-weight: 600; color: var(--text-primary); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr:hover { background-color: var(--brand-secondary); }
        .status-pill { padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 0.8rem; }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-planned { background-color: #cce5ff; color: #004085; }
        .impact-score { font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .impact-score .fa-star { color: #ffc107; }

        /* Gap Analysis */
        #gap-analysis-title { text-align: center; margin:0 0 16px 0; color: var(--text-primary); font-weight: 500; }
        .gap-bar-container { position: relative; height: 30px; background-color: var(--bg-main); border-radius: var(--radius-md); overflow: hidden; margin-top: 8px; border: 1px solid var(--border-color); }
        .gap-bar-reached { position: absolute; left: 0; top: 0; height: 100%; background-color: var(--success-color); transition: width 0.5s; }
        .gap-bar-gap { position: absolute; right: 0; top: 0; height: 100%; background-color: var(--gap-color); opacity: 0.7; transition: width 0.5s; }
        .gap-labels { display: flex; justify-content: space-between; margin-top: 8px; font-weight: 600; }

        /* Situation Summary */
        .summary-container {
            margin-bottom: 24px;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 24px;
            border: 1px solid var(--border-color);
        }
        .summary-container h2 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .summary-container h2 i {
            color: var(--brand-primary);
            font-size: 1.1em;
        }
        .summary-content {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.8;
        }
        .summary-content p {
            margin: 0 0 12px 0;
        }
        .summary-content strong {
            color: var(--text-primary);
        }
        .province-label { font-size: 12px; font-weight: bold; color: #000; background: rgba(255, 255, 255, 0.7); padding: 2px 6px; border-radius: 3px; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header>
            <h1><img src="./Layers/wdclogobg-DaW87GU_.png" alt="Logo"> Afghanistan Earthquake Response</h1>
            <p>An integrated platform for real-time situational analysis, needs assessment, and coordinated response tracking for the recent earthquake event in Kunar and Nangarhar.</p>
        </header>

        <section class="summary-container">
            <h2><i class="fas fa-info-circle"></i> Situation Summary</h2>
            <div class="summary-content" id="situation-summary"></div>
        </section>
        
        <section class="filter-container">
            <div class="filter-group">
                <label for="geo-filter"><i class="fas fa-globe-americas"></i> Geography</label>
                <select id="geo-filter">
                    <option>All Affected Provinces</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="pop-filter"><i class="fas fa-users"></i> Population Group</label>
                <select id="pop-filter">
                    <option>All Population Groups</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sector-filter"><i class="fas fa-medkit"></i> Sector of Need</label>
                <select id="sector-filter">
                    <option>All Sectors</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="view-filter"><i class="fas fa-eye"></i> View</label>
                <select id="view-filter">
                    <option>All</option>
                    <option>Houses</option>
                    <option>People</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="intensity-filter"><i class="fas fa-home"></i> House Damage Intensity</label>
                <select id="intensity-filter">
                    <option>All Intensities</option>
                    <option>High</option>
                    <option>Medium</option>
                    <option>Low</option>
                </select>
            </div>
        </section>

        <main class="main-grid">
            <div class="grid-span-7">
                <div class="module-card map-module">
                    <div id="map"></div>
                    <div class="map-legend">
                        <h4>Map Layers</h4>
                        <div class="legend-item"><img src="./Layers/house.png" style="width: 15px; height: 15px;"> Houses</div>
                        <div class="legend-item"><i class="fas fa-star" style="color: #ff0000;"></i> Epicenter</div>
                        <div class="legend-item"><div class="legend-circle" style="background-color: #d73027; opacity:0.5;"></div> Intensity Zones</div>
                        <div class="legend-item"><div class="legend-circle" style="border: 1px solid #000000;"></div> Province Boundaries</div>
                        <h4>People in Need</h4>
                        <div class="legend-item"><div class="legend-circle" style="background-color: orange; opacity:0.7;"></div> Affected</div>
                        <div class="legend-item"><div class="legend-circle" style="background-color: blue; opacity:0.7;"></div> Displaced</div>
                    </div>
                </div>
            </div>

            <div class="grid-span-5">
                <div class="module-card">
                    <h2><i class="fas fa-tachometer-alt"></i> Key Metrics Overview</h2>
                    <div class="metrics-grid">
                        <div class="metric-card"><h3>Total Population</h3><p id="metric-total-pop">0</p></div>
                        <div class="metric-card"><h3>People in Need</h3><p id="metric-total-need">0</p></div>
                        <div class="metric-card"><h3>Displaced</h3><p id="metric-displaced">0</p></div>
                        <div class="metric-card"><h3>With Disabilities</h3><p id="metric-pwd">0</p></div>
                        <div class="metric-card"><h3>Female-Headed HH</h3><p id="metric-fhh">0</p></div>
                        <div class="metric-card"><h3>Houses Destroyed</h3><p id="metric-houses-destroyed">0</p></div>
                    </div>
                </div>
                <div class="module-card">
                    <h2><i class="fas fa-crosshairs"></i> Response Gap Analysis</h2>
                    <h3 id="gap-analysis-title"></h3>
                    <div class="metrics-grid">
                        <div class="metric-card"><h3>Target</h3><p id="kpi-target">0</p></div>
                        <div class="metric-card"><h3>Reached</h3><p id="kpi-reached">0</p></div>
                        <div class="metric-card"><h3>Gap</h3><p id="kpi-gap">0</p></div>
                    </div>
                    <div class="gap-bar-container">
                        <div class="gap-bar-reached" id="gap-bar-reached"></div>
                        <div class="gap-bar-gap" id="gap-bar-gap"></div>
                    </div>
                    <div class="gap-labels">
                        <span id="coverage-label">Coverage: 0%</span>
                        <span id="gap-label">Gap: 100%</span>
                    </div>
                </div>
            </div>
            
            <div class="grid-span-12">
                <section class="module-card">
                    <h2><i class="fas fa-users-viewfinder"></i> Disaggregated Population Analysis</h2>
                    <div style="display: flex; gap: 24px;">
                        <div style="flex: 1;">
                            <h3>Normal Population</h3>
                            <div class="pyramid-container">
                                <div class="pyramid-side male" id="pyramid-male-bars-normal"></div>
                                <div class="age-labels" id="pyramid-age-labels-normal"></div>
                                <div class="pyramid-side female" id="pyramid-female-bars-normal"></div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <h3>Displaced / PIN Population</h3>
                            <div class="pyramid-container">
                                <div class="pyramid-side male" id="pyramid-male-bars-displaced"></div>
                                <div class="age-labels" id="pyramid-age-labels-displaced"></div>
                                <div class="pyramid-side female" id="pyramid-female-bars-displaced"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pyramid-legend">
                        <div class="legend-item"><div class="legend-swatch" style="background-color: var(--male-color);"></div>Male</div>
                        <div class="legend-item"><div class="legend-swatch" style="background: repeating-linear-gradient(45deg, var(--male-color), var(--male-color) 4px, #a8d5e9 4px, #a8d5e9 8px);"></div>Male (w/ Disability)</div>
                        <div class="legend-item"><div class="legend-swatch" style="background-color: var(--female-color);"></div>Female</div>
                        <div class="legend-item"><div class="legend-swatch" style="background: repeating-linear-gradient(45deg, var(--female-color), var(--female-color) 4px, #f2a2a2 4px, #f2a2a2 8px);"></div>Female (w/ Disability)</div>
                    </div>
                </section>
            </div>
            
            <div class="grid-span-5">
                <section class="module-card">
                    <h2><i class="fas fa-chart-bar"></i> Response by Sector</h2>
                    <div class="chart-container" id="sectoral-chart-container"></div>
                </section>
            </div>

            <div class="grid-span-7">
                <section class="module-card">
                    <h2><i class="fas fa-tasks"></i> Response Tracking (Who, What, Where, When)</h2>
                    <div class="table-wrapper">
                        <table id="response-table">
                            <thead><tr><th>Organization</th><th>Activity</th><th>Timeline</th><th>Status</th><th>Impact (# Reached)</th></tr></thead>
                            <tbody id="response-table-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
    // --- DOM ELEMENT REFERENCES ---
    const elements = {
        map: L.map('map', { scrollWheelZoom: false }),
        metricTotalPop: document.getElementById('metric-total-pop'),
        metricTotalNeed: document.getElementById('metric-total-need'),
        metricDisplaced: document.getElementById('metric-displaced'),
        metricPwd: document.getElementById('metric-pwd'),
        metricFhh: document.getElementById('metric-fhh'),
        metricHousesDestroyed: document.getElementById('metric-houses-destroyed'),
        maleBarsNormal: document.getElementById('pyramid-male-bars-normal'),
        femaleBarsNormal: document.getElementById('pyramid-female-bars-normal'),
        ageLabelsNormal: document.getElementById('pyramid-age-labels-normal'),
        maleBarsDisplaced: document.getElementById('pyramid-male-bars-displaced'),
        femaleBarsDisplaced: document.getElementById('pyramid-female-bars-displaced'),
        ageLabelsDisplaced: document.getElementById('pyramid-age-labels-displaced'),
        gapTitle: document.getElementById('gap-analysis-title'),
        kpiTarget: document.getElementById('kpi-target'),
        kpiReached: document.getElementById('kpi-reached'),
        kpiGap: document.getElementById('kpi-gap'),
        gapBarReached: document.getElementById('gap-bar-reached'),
        gapBarGap: document.getElementById('gap-bar-gap'),
        coverageLabel: document.getElementById('coverage-label'),
        gapLabel: document.getElementById('gap-label'),
        sectoralChart: document.getElementById('sectoral-chart-container'),
        responseBody: document.getElementById('response-table-body'),
        situationSummary: document.getElementById('situation-summary')
    };
    const mapMarkers = L.layerGroup();
    elements.map.setView([34.5, 69.2], 6); // Center on Afghanistan
    mapMarkers.addTo(elements.map);
    const dataPath = './Layers/'; // Path to data folder

    // Layer groups for houses and zones by intensity
    const houseLayers = { Houses: null };
    const zoneLayers = { Epicenter: null, Intensity: null, Provinces: null };

    // Layer groups for population points
    const peopleLayers = {
        Affected: L.layerGroup(),
        Displaced: L.layerGroup()
    };

    let provinceList = [];
    let sectorList = [];

    // --- HELPER & UI UPDATE FUNCTIONS ---
    function formatNumber(num) {
        if (isNaN(num)) return '0';
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
        return num.toLocaleString() || '0';
    }

    function getStarRating(impact) {
        const stars = Math.min(Math.floor(impact * 50 / 1000), 5); // 1 star per 50k, max 5
        return '★'.repeat(stars) + '☆'.repeat(5 - stars);
    }

    function updateMetrics(data) {
        elements.metricTotalPop.textContent = formatNumber(data.totalPop || 0);
        elements.metricTotalNeed.textContent = formatNumber(Math.min(data.totalNeed || 0, data.totalPop || 0));
        elements.metricDisplaced.textContent = formatNumber(data.displaced || 0);
        elements.metricPwd.textContent = formatNumber(data.pwd || 0);
        elements.metricFhh.textContent = formatNumber(data.fhh || 0);
        elements.metricHousesDestroyed.textContent = formatNumber(data.housesDestroyed || 0);
    }

    function updatePyramid(pyramidData, isDisplaced = false) {
        const suffix = isDisplaced ? 'Displaced' : 'Normal';
        const maleBars = elements[`maleBars${suffix}`];
        const femaleBars = elements[`femaleBars${suffix}`];
        const ageLabels = elements[`ageLabels${suffix}`];
        maleBars.innerHTML = '';
        femaleBars.innerHTML = '';
        ageLabels.innerHTML = '';
        if (!pyramidData || pyramidData.length === 0) return;
        const maxPop = Math.max(...pyramidData.map(d => Math.max((d.male || 0) + (d.male_dis || 0), (d.female || 0) + (d.female_dis || 0))));
        pyramidData.forEach(d => {
            ageLabels.innerHTML += `<div>${d.age || 'No data available'}</div>`;
            const totalMale = (d.male || 0) + (d.male_dis || 0);
            const maleWidth = maxPop > 0 ? (totalMale / maxPop) * 100 : 0;
            const maleDisWidth = totalMale > 0 ? ((d.male_dis || 0) / totalMale) * 100 : 0;
            maleBars.innerHTML += `<div class="bar-wrapper" style="width: ${maleWidth}%;"><div class="bar-disability" style="width: ${maleDisWidth}%;"></div><div class="bar-main" style="width: ${100 - maleDisWidth}%;"></div><span class="bar-label">${formatNumber(totalMale)}</span></div>`;
            
            const totalFemale = (d.female || 0) + (d.female_dis || 0);
            const femaleWidth = maxPop > 0 ? (totalFemale / maxPop) * 100 : 0;
            const femaleDisWidth = totalFemale > 0 ? ((d.female_dis || 0) / totalFemale) * 100 : 0;
            femaleBars.innerHTML += `<div class="bar-wrapper" style="width: ${femaleWidth}%;"><div class="bar-main" style="width: ${100 - femaleDisWidth}%;"></div><div class="bar-disability" style="width: ${femaleDisWidth}%;"></div><span class="bar-label">${formatNumber(totalFemale)}</span></div>`;
        });
    }

    function updateKPIs(gapData) {
        const maxNeed = 1447224; // Updated cap for Kunar + Nangarhar
        elements.gapTitle.textContent = gapData.title || 'Overall Response Gap';
        elements.kpiTarget.textContent = formatNumber(Math.min(gapData.target || 0, maxNeed));
        elements.kpiReached.textContent = formatNumber(Math.min(gapData.reached || 0, maxNeed));
        const gapValue = Math.max(0, Math.min(gapData.target || 0, maxNeed) - Math.min(gapData.reached || 0, maxNeed));
        elements.kpiGap.textContent = formatNumber(gapValue);
        
        const coveragePercent = Math.min(gapData.target || 0, maxNeed) > 0 ? (Math.min(gapData.reached || 0, maxNeed) / Math.min(gapData.target || 0, maxNeed)) * 100 : 0;
        const gapPercent = 100 - coveragePercent;
        
        elements.gapBarReached.style.width = `${coveragePercent}%`;
        elements.gapBarGap.style.width = `${gapPercent}%`;
        elements.coverageLabel.textContent = `Coverage: ${coveragePercent.toFixed(1)}%`;
        elements.gapLabel.textContent = `Gap: ${gapPercent.toFixed(1)}%`;
    }

    function updatePartnerChart(coverageData) {
        elements.sectoralChart.innerHTML = '';
        if (!coverageData) return;
        let dataArray = Object.entries(coverageData.sector_specific_needs || {}).map(([sector, d]) => ({
            sector,
            coverage: d.target > 0 ? (d.reached / d.target) * 100 : 0
        }));
        dataArray.sort((a, b) => b.coverage - a.coverage);
        dataArray.forEach(d => {
            elements.sectoralChart.innerHTML += `
                <div class="chart-row">
                    <div class="chart-label">${d.sector || 'No data available'}</div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar-fg" style="width: ${d.coverage || 0}%;">${d.coverage.toFixed(1) || 0}%</div>
                    </div>
                </div>`;
        });
    }

    function updateResponseTable(responses) {
        elements.responseBody.innerHTML = '';
        if (!responses || responses.length === 0) return;
        const now = new Date();
        const collectionTime = now.toLocaleString('en-US', { month: 'long', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true, timeZoneName: 'short' });
        responses.forEach(item => {
            const stars = getStarRating(item.people_reached || item.reached || 0);
            elements.responseBody.innerHTML += `<tr>
                <td>${item.organization || 'No data available'}</td>
                <td>${item.main_activity || item.activity || 'No data available'}</td>
                <td>${item.source_time || 'No data available'} (Collected: ${collectionTime})</td>
                <td><span class="status-pill status-${(item.status || 'planned').toLowerCase()}">${item.status || 'Planned'}</span></td>
                <td class="impact-score">${stars} (${formatNumber(item.people_reached || item.reached || 0)})</td>
            </tr>`;
        });
    }

    function updateSituationSummary(summary) {
        if (!summary) return;
        elements.situationSummary.innerHTML = summary.replace(/\n\n/g, '</p><p>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }

    function applyFilters() {
        const geo = document.getElementById('geo-filter').value;
        const pop = document.getElementById('pop-filter').value;
        const sector = document.getElementById('sector-filter').value;
        const view = document.getElementById('view-filter').value;
        const intensity = document.getElementById('intensity-filter').value;

        mapMarkers.clearLayers();

        if (view === 'All' || view === 'Houses') {
            if (houseLayers.Houses) {
                houseLayers.Houses.eachLayer(l => {
                    const shouldShow = (geo === 'All Affected Provinces' || l.feature.properties.label === geo) &&
                                       (sector === 'All Sectors' || l.feature.properties.sector === sector);
                    if (l instanceof L.Marker) {
                        l.setOpacity(shouldShow ? 1 : 0);
                    } else {
                        l.setStyle({ opacity: shouldShow ? 1 : 0, fillOpacity: shouldShow ? 0.7 : 0 });
                    }
                });
                mapMarkers.addLayer(houseLayers.Houses);
            }
            Object.values(zoneLayers).forEach(layer => {
                if (layer) {
                    layer.eachLayer(l => {
                        const shouldShow = (geo === 'All Affected Provinces' || l.feature.properties.shapeName === geo) &&
                                           (sector === 'All Sectors' || l.feature.properties.sector === sector);
                        l.setStyle({ opacity: shouldShow ? 1 : 0, fillOpacity: shouldShow ? 0.04 : 0, weight: 1 });
                    });
                    mapMarkers.addLayer(layer);
                }
            });
        }

        if (view === 'All' || view === 'People') {
            if (pop === 'All Population Groups') {
                Object.values(peopleLayers).forEach(group => {
                    group.eachLayer(l => {
                        const shouldShow = (geo === 'All Affected Provinces' || l.options.province === geo) &&
                                           (sector === 'All Sectors' || l.options.sector === sector);
                        l.setStyle({ opacity: shouldShow ? 1 : 0, fillOpacity: shouldShow ? 0.7 : 0 });
                    });
                    mapMarkers.addLayer(group);
                });
            } else if (pop in peopleLayers) {
                peopleLayers[pop].eachLayer(l => {
                    const shouldShow = (geo === 'All Affected Provinces' || l.options.province === geo) &&
                                       (sector === 'All Sectors' || l.options.sector === sector);
                    l.setStyle({ opacity: shouldShow ? 1 : 0, fillOpacity: shouldShow ? 0.7 : 0 });
                });
                mapMarkers.addLayer(peopleLayers[pop]);
            }
        }
    }

    async function loadMetrics() {
        let totalPop = 1400000; // Updated to 1.4M
        let totalNeed = 1100000; // Updated to 1.1M to match Target
        let displaced = 231600; // Updated to 231.6k
        let pwd = 188100; // Updated to 188.1k
        let fhh = 361800; // Updated to 361.8k
        let housesDestroyed = 592; // Updated to 592
        const provinces = new Set(['Kunar', 'Nangarhar']);

        try {
            const disResp = await fetch(dataPath + 'disability_data.json');
            const disJson = await disResp.json();
            pwd = Math.round(totalPop * (disJson.disability_data.prevalence_overall || 0));
        } catch (e) {
            console.warn('Failed to load disability_data.json:', e);
        }

        try {
            const fhhResp = await fetch(dataPath + 'fhh_data.json');
            const fhhJson = await fhhResp.json();
            fhh = Math.round(totalPop * (fhhJson.fhh_data.percentage_overall / 100));
        } catch (e) {
            console.warn('Failed to load fhh_data.json:', e);
        }

        try {
            const [highResp, medResp, lowResp] = await Promise.all([
                fetch(dataPath + 'houses_high.geojson'),
                fetch(dataPath + 'houses_medium.geojson'),
                fetch(dataPath + 'houses_low.geojson')
            ]);
            const [highJson, medJson, lowJson] = await Promise.all([highResp.json(), medResp.json(), lowResp.json()]);
            housesDestroyed = highJson.features.length + medJson.features.length + lowJson.features.length;
        } catch (e) {
            console.warn('Failed to load house data:', e);
        }

        provinceList = Array.from(provinces).sort();
        updateMetrics({ totalPop, totalNeed, displaced, pwd, fhh, housesDestroyed });
    }

    async function loadGapAnalysis() {
        let target = 882700; // Updated to 882.7k
        let reached = 0;
        try {
            const newsResp = await fetch(dataPath + 'response_data.json');
            const newsJson = await newsResp.json();
            reached = newsJson.response_data.reduce((sum, item) => sum + (parseFloat(item.people_reached || item.reached || 0)), 0);
        } catch (e) {
            console.warn('Failed to load sector_specific_needs.json for gap:', e);
        }
        updateKPIs({ target, reached, title: 'Overall Response Gap' });
    }

    async function loadPyramidData(file, isDisplaced = false) {
        try {
            const resp = await fetch(dataPath + file);
            const json = await resp.json();
            let data = isDisplaced ? json : json.pyramid_data || [];
            const pyramidData = data.map(d => ({
                age: isDisplaced ? d.age_group.replace(/_/g, '-') : d.age || 'Unknown',
                male: parseFloat(isDisplaced ? d.male_PIN : d.male) || 0,
                female: parseFloat(isDisplaced ? d.female_PIN : d.female) || 0,
                male_dis: parseFloat(isDisplaced ? d.male_disability : d.male_dis) || 0,
                female_dis: parseFloat(isDisplaced ? d.female_disability : d.female_dis) || 0
            }));
            pyramidData.sort((a, b) => parseInt(a.age.split('-')[0]) - parseInt(b.age.split('-')[0]));
            return pyramidData;
        } catch (e) {
            console.warn(`Failed to load pyramid data from ${file}:`, e);
            return [];
        }
    }

    async function loadResponseData() {
        let responses = [];
        let sectorData = {};
        try {
            const newsResp = await fetch(dataPath + 'response_data.json');
            responses = (await newsResp.json()).response_data || [];
        } catch (e) {
            console.warn('Failed to load response_data.json:', e);
        }
        try {
            const sectorResp = await fetch(dataPath + 'sector_specific_needs.json');
            sectorData = (await sectorResp.json()).sector_specific_needs || {};
            sectorList = Object.keys(sectorData).sort();
        } catch (e) {
            console.warn('Failed to load sector_specific_needs.json:', e);
        }
        updateResponseTable(responses);
        updatePartnerChart({ sector_specific_needs: sectorData });
    }

    async function loadSituationSummary() {
        try {
            const summaryResp = await fetch(dataPath + 'summary.json');
            const summaryJson = await summaryResp.json();
            updateSituationSummary(summaryJson.summary || '');
        } catch (e) {
            console.warn('Failed to load summary.json:', e);
        }
    }

    async function loadPeoplePoints() {
        // Initialize marker cluster groups
        peopleLayers.Affected = L.markerClusterGroup({
            iconCreateFunction: cluster => {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div style="background-color: orange; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${formatNumber(count)}</div>`,
                    className: 'marker-cluster',
                    iconSize: [30, 30]
                });
            }
        });
        peopleLayers.Displaced = L.markerClusterGroup({
            iconCreateFunction: cluster => {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div style="background-color: blue; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${formatNumber(count)}</div>`,
                    className: 'marker-cluster',
                    iconSize: [30, 30]
                });
            }
        });

        try {
            const popResp = await fetch(dataPath + 'pop_clipped_points.geojson');
            const popJson = await popResp.json();
            popJson.features.forEach(f => {
                const province = f.properties.province || 'Unknown';
                const population = parseFloat(f.properties.population) || 0;
                const lat = parseFloat(f.properties.latitude);
                const lng = parseFloat(f.properties.longitude);
                if (!isNaN(lat) && !isNaN(lng) && population > 0) {
                    const marker = L.circleMarker([lat, lng], {
                        radius: Math.max(1, Math.min(5, Math.sqrt(population) / 10)),
                        fillColor: 'orange',
                        color: '#000',
                        weight: 0.5,
                        opacity: 1,
                        fillOpacity: 0.7,
                        province,
                        sector: 'General'
                    }).bindPopup(`Province: ${province}<br>Type: Affected<br>Population: ${formatNumber(population)}`);
                    peopleLayers.Affected.addLayer(marker);
                }
            });
        } catch (e) {
            console.warn('Failed to load pop_clipped_points.geojson:', e);
        }

        try {
            const dispResp = await fetch(dataPath + 'pop_clipped_points_displaced_normalized.geojson');
            const dispJson = await dispResp.json();
            dispJson.features.forEach(f => {
                const province = f.properties.province || 'Unknown';
                const displaced = parseFloat(f.properties.estimated_displaced) || 0;
                const lat = parseFloat(f.properties.latitude);
                const lng = parseFloat(f.properties.longitude);
                const ageGroup = f.properties.age_group || 'Unknown';
                if (!isNaN(lat) && !isNaN(lng) && displaced > 0) {
                    const marker = L.circleMarker([lat, lng], {
                        radius: Math.max(1, Math.min(5, Math.sqrt(displaced) / 10)),
                        fillColor: 'blue',
                        color: '#000',
                        weight: 0.5,
                        opacity: 1,
                        fillOpacity: 0.7,
                        province,
                        sector: 'Displaced'
                    }).bindPopup(`Province: ${province}<br>Type: Displaced<br># people: ${formatNumber(displaced)}<br>Age Group: ${ageGroup}`);
                    peopleLayers.Displaced.addLayer(marker);
                }
            });
        } catch (e) {
            console.warn('Failed to load pop_clipped_points_displaced_normalized.geojson:', e);
        }

        mapMarkers.addLayer(peopleLayers.Affected);
        mapMarkers.addLayer(peopleLayers.Displaced);
    }

    async function loadMapLayer(file, color, isZone = false, icon = null) {
        try {
            const response = await fetch(dataPath + file);
            if (!response.ok) throw new Error(`Failed to load ${file}`);
            const geojson = await response.json();
            return L.geoJSON(geojson, {
                pointToLayer: (feature, latlng) => {
                    if (isZone) return null;
                    if (icon) return L.marker(latlng, { icon });
                    return L.circleMarker(latlng, {
                        radius: Math.max(1, Math.min(5, Math.sqrt(feature.properties.population || feature.properties.estimated_displaced || 1) / 10)),
                        fillColor: color,
                        color: '#000',
                        weight: 0.5,
                        opacity: 1,
                        fillOpacity: 0.7,
                        province: feature.properties.shapeName || feature.properties.province || 'Unknown',
                        sector: file.includes('displaced') ? 'Displaced' : 'General'
                    });
                },
                style: isZone ? { fillColor: color, color: '#000', weight: 1, fillOpacity: 0.3 } : null,
                onEachFeature: (feature, layer) => {
                    let popupText = '';
                    if (feature.properties) {
                        if (feature.properties.shapeName) popupText += `<b>Province:</b> ${feature.properties.shapeName}<br>`;
                        if (feature.properties.label) popupText += `<b>Info:</b> ${feature.properties.label}<br>`;
                        if (feature.properties.intensity) popupText += `<b>Intensity:</b> ${feature.properties.intensity}<br>`;
                        if (feature.properties.population) popupText += `<b>Population:</b> ${formatNumber(feature.properties.population)}<br>`;
                        if (feature.properties.estimated_displaced) popupText += `<b>Displaced:</b> ${formatNumber(feature.properties.estimated_displaced)}<br>`;
                        if (feature.properties.age_group) popupText += `<b>Age Group:</b> ${feature.properties.age_group}`;
                    }
                    layer.bindPopup(popupText || 'No data available');
                }
            });
        } catch (e) {
            console.warn(`Failed to load map layer ${file}: ${e}`);
            return null;
        }
    }

    async function initializeMap() {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(elements.map);
        
        const houseIcon = L.icon({ iconUrl: dataPath + 'house.png', iconSize: [24, 24], iconAnchor: [12, 12] });
        houseLayers.Houses = await loadMapLayer('houses.geojson', null, false, houseIcon);
        zoneLayers.Epicenter = await loadMapLayer('epicenter_impact.geojson', '#ff0000', true, L.divIcon({ html: '<i class="fas fa-star" style="color: #ff0000; font-size: 48px;"></i>', className: 'epicenter-star' }));
        zoneLayers.Intensity = await loadMapLayer('intensity_zones.geojson', '#d73027', true);
        zoneLayers.Provinces = await loadMapLayer('geoBoundaries-AFG-ADM1_simplified.geojson', '#000000', true);

        if (houseLayers.Houses) mapMarkers.addLayer(houseLayers.Houses);

        // Epicenter fill
        if (zoneLayers.Epicenter) zoneLayers.Epicenter.eachLayer(l => l.setStyle({ fillOpacity: 0.9, fillColor: '#ff0000' }));

        // Intensity zones: 90% transparent fill, keep red outline
        if (zoneLayers.Intensity) zoneLayers.Intensity.eachLayer(l => 
        l.setStyle({ fillOpacity: 0.1, color: '#d73027', weight: 1 })
        
        );

    // Provinces: fully transparent fill, only contour with black line
    if (zoneLayers.Provinces) zoneLayers.Provinces.eachLayer(l => 
        l.setStyle({ fillOpacity: 0, color: '#000000', weight: 2, dashArray: '5,5' })
    );
    if (zoneLayers.Provinces) zoneLayers.Provinces.eachLayer(l => l.bindTooltip(l.feature.properties.shapeName, { permanent: true, direction: 'center', className: 'province-label' }));

    await loadPeoplePoints();
    applyFilters();
}

    async function initializeDashboard() {
        await Promise.all([
            initializeMap(),
            loadMetrics(),
            loadGapAnalysis(),
            loadPyramidData('population_pyramid.json').then(data => updatePyramid(data)),
            loadPyramidData('PIN_pyramid.json', true).then(data => updatePyramid(data, true)),
            loadResponseData(),
            loadSituationSummary()
        ]);

        const geoFilter = document.getElementById('geo-filter');
        provinceList.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            geoFilter.appendChild(option);
        });

        const sectorFilter = document.getElementById('sector-filter');
        sectorList.forEach(sector => {
            const option = document.createElement('option');
            option.value = sector;
            option.textContent = sector;
            sectorFilter.appendChild(option);
        });

        const popFilter = document.getElementById('pop-filter');
        ['All Population Groups', 'Affected', 'Displaced'].forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            popFilter.appendChild(option);
        });

        ['geo-filter', 'pop-filter', 'sector-filter', 'view-filter', 'intensity-filter'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
    }

    initializeDashboard();
    </script>
</body>
</html>